<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ethanwhite-chen.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="如果你用 redis 缓存技术的话，肯定要考虑如何用 redis 来加多台机器，保证 redis 是高并发的，还有就是如何让 redis 保证自己不是挂掉以后就直接死掉了，即 redis 高可用。 由于此节内容较多，因此，会分为两个小节进行讲解。  redis 主从架构 redis 基于哨兵实现高可用  Redis 主从架构 单机的 redis，能够承载的 QPS 大概就在上万到几万不等。对于缓存">
<meta property="og:type" content="article">
<meta property="og:title" content="如何保证 redis 的高并发和高可用？">
<meta property="og:url" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/index.html">
<meta property="og:site_name" content="ykchen的个人博客">
<meta property="og:description" content="如果你用 redis 缓存技术的话，肯定要考虑如何用 redis 来加多台机器，保证 redis 是高并发的，还有就是如何让 redis 保证自己不是挂掉以后就直接死掉了，即 redis 高可用。 由于此节内容较多，因此，会分为两个小节进行讲解。  redis 主从架构 redis 基于哨兵实现高可用  Redis 主从架构 单机的 redis，能够承载的 QPS 大概就在上万到几万不等。对于缓存">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/j5hcino47d.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/j1tiqlu8f3.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/vhgsx88g20.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/dy25zd7xc0.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/uo069eiopx.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/49c37tz8j9.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/it3cdc8xvp.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/7eyyyn1obp.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/808e3izvdh.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/k8zcq5yvs2.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/9n5cusr6j9.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/n11rtq4vp6.png">
<meta property="og:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/lj99ax1xuh.png">
<meta property="article:published_time" content="2023-05-24T12:20:25.000Z">
<meta property="article:modified_time" content="2023-05-24T15:10:40.740Z">
<meta property="article:author" content="EthanWhite-Chen">
<meta property="article:tag" content="java">
<meta property="article:tag" content="redis高可用">
<meta property="article:tag" content="redis高并发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/j5hcino47d.png">

<link rel="canonical" href="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>如何保证 redis 的高并发和高可用？ | ykchen的个人博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ykchen的个人博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">欢迎来到ykchen的技术总结分享博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/ethanwhite-chen" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://ethanwhite-chen.github.io/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="EthanWhite-Chen">
      <meta itemprop="description" content="不积跬步无以至千里，不积小流无以成江河。分享点滴成长，就有光明未来！">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ykchen的个人博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          如何保证 redis 的高并发和高可用？
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-05-24 20:20:25 / Modified: 23:10:40" itemprop="dateCreated datePublished" datetime="2023-05-24T20:20:25+08:00">2023-05-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9D%A2%E8%AF%95%E9%A2%98%E7%9B%AE/" itemprop="url" rel="index"><span itemprop="name">面试题目</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>23k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>41 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>如果你用 <a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/crs?from=20065&from_column=20065">redis</a> 缓存技术的话，肯定要考虑如何用 redis 来加多台机器，保证 redis 是高并发的，还有就是如何让 redis 保证自己不是挂掉以后就直接死掉了，即 redis 高可用。</p>
<p>由于此节内容较多，因此，会分为两个小节进行讲解。</p>
<ul>
<li>redis 主从架构</li>
<li>redis 基于哨兵实现高可用</li>
</ul>
<p>Redis 主从架构</p>
<p>单机的 redis，能够承载的 QPS 大概就在上万到几万不等。对于缓存来说，一般都是用来支撑读高并发的。因此架构做成主从(master-slave)架构，一主多从，主负责写，并且将数据复制到其它的 slave 节点，从节点负责读。所有的读请求全部走从节点。这样也可以很轻松实现水平扩容，支撑读高并发。</p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/j5hcino47d.png" class title="img">

<p>redis replication -&gt; 主从架构 -&gt; 读写分离 -&gt; 水平扩容支撑读高并发</p>
<h2 id="redis-replication-的核心机制"><a href="#redis-replication-的核心机制" class="headerlink" title="redis replication 的核心机制"></a>redis replication 的核心机制</h2><ul>
<li>redis 采用异步方式复制数据到 slave 节点，不过 redis2.8 开始，slave node 会周期性地确认自己每次复制的数据量；</li>
<li>一个 master node 是可以配置多个 slave node 的；</li>
<li>slave node 也可以连接其他的 slave node；</li>
<li>slave node 做复制的时候，不会 block master node 的正常工作；</li>
<li>slave node 在做复制的时候，也不会 block 对自己的查询操作，它会用旧的数据集来提供服务；但是复制完成的时候，需要删除旧数据集，加载新数据集，这个时候就会暂停对外服务了；</li>
<li>slave node 主要用来进行横向扩容，做读写分离，扩容的 slave node 可以提高读的吞吐量。</li>
</ul>
<p>注意，如果采用了主从架构，那么建议必须开启 master node 的持久化，不建议用 slave node 作为 master node 的数据热备，因为那样的话，如果你关掉 master 的持久化，可能在 master 宕机重启的时候数据是空的，然后可能一经过复制， slave node 的数据也丢了。</p>
<p>另外，master 的各种备份方案，也需要做。万一本地的所有文件丢失了，从备份中挑选一份 rdb 去恢复 master，这样才能确保启动的时候，是有数据的，即使采用了后续讲解的高可用机制，slave node 可以自动接管 master node，但也可能 sentinel 还没检测到 master failure，master node 就自动重启了，还是可能导致上面所有的 slave node 数据被清空。</p>
<h2 id="redis-主从复制的核心原理"><a href="#redis-主从复制的核心原理" class="headerlink" title="redis 主从复制的核心原理"></a>redis 主从复制的核心原理</h2><p>当启动一个 slave node 的时候，它会发送一个 <code>PSYNC</code> 命令给 master node。</p>
<p>如果这是 slave node 初次连接到 master node，那么会触发一次 <code>full resynchronization</code> 全量复制。此时 master 会启动一个后台线程，开始生成一份 <code>RDB</code> 快照文件，同时还会将从客户端 client 新收到的所有写命令缓存在内存中。<code>RDB</code> 文件生成完毕后， master 会将这个 <code>RDB</code> 发送给 slave，slave 会先写入本地磁盘，然后再从本地磁盘加载到内存中，接着 master 会将内存中缓存的写命令发送到 slave，slave 也会同步这些数据。slave node 如果跟 master node 有网络故障，断开了连接，会自动重连，连接之后 master node 仅会复制给 slave 部分缺少的数据。</p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/j1tiqlu8f3.png" class title="img">

<h3 id="主从复制的断点续传"><a href="#主从复制的断点续传" class="headerlink" title="主从复制的断点续传"></a>主从复制的断点续传</h3><p>从 redis2.8 开始，就支持主从复制的断点续传，如果主从复制过程中，网络连接断掉了，那么可以接着上次复制的地方，继续复制下去，而不是从头开始复制一份。</p>
<p>master node 会在内存中维护一个 backlog，master 和 slave 都会保存一个 replica offset 还有一个 master run id，offset 就是保存在 backlog 中的。如果 master 和 slave 网络连接断掉了，slave 会让 master 从上次 replica offset 开始继续复制，如果没有找到对应的 offset，那么就会执行一次 <code>resynchronization</code>。</p>
<blockquote>
<p>如果根据 host+ip 定位 master node，是不靠谱的，如果 master node 重启或者数据出现了变化，那么 slave node 应该根据不同的 run id 区分。</p>
</blockquote>
<h3 id="无磁盘化复制"><a href="#无磁盘化复制" class="headerlink" title="无磁盘化复制"></a>无磁盘化复制</h3><p>master 在内存中直接创建 <code>RDB</code>，然后发送给 slave，不会在自己本地落地磁盘了。只需要在配置文件中开启 <code>repl-diskless-sync yes</code> 即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">repl-diskless-sync yes</span><br><span class="line"># 等待 5s 后再开始复制，因为要等更多 slave 重新连接过来</span><br><span class="line">repl-diskless-sync-delay <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<h3 id="过期-key-处理"><a href="#过期-key-处理" class="headerlink" title="过期 key 处理"></a>过期 key 处理</h3><p>slave 不会过期 key，只会等待 master 过期 key。如果 master 过期了一个 key，或者通过 LRU 淘汰了一个 key，那么会模拟一条 del 命令发送给 slave。</p>
<h2 id="复制的完整流程"><a href="#复制的完整流程" class="headerlink" title="复制的完整流程"></a>复制的完整流程</h2><p>slave node 启动时，会在自己本地保存 master node 的信息，包括 master node 的<code>host</code>和<code>ip</code>，但是复制流程没开始。</p>
<p>slave node 内部有个定时任务，每秒检查是否有新的 master node 要连接和复制，如果发现，就跟 master node 建立 socket 网络连接。然后 slave node 发送 <code>ping</code> 命令给 master node。如果 master 设置了 requirepass，那么 slave node 必须发送 masterauth 的口令过去进行认证。master node 第一次执行全量复制，将所有数据发给slave node。而在后续，master node 持续将写命令，异步复制给 slave node。</p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/vhgsx88g20.png" class title="img">

<h3 id="全量复制"><a href="#全量复制" class="headerlink" title="全量复制"></a>全量复制</h3><ul>
<li>master 执行 bgsave ，在本地生成一份 rdb 快照文件。</li>
<li>master node 将 rdb 快照文件发送给 slave node，如果 rdb 复制时间超过 60秒（repl-timeout），那么 slave node 就会认为复制失败，可以适当调大这个参数(对于千兆网卡的机器，一般每秒传输 100MB，6G 文件，很可能超过 60s)</li>
<li>master node 在生成 rdb 时，会将所有新的写命令缓存在内存中，在 slave node 保存了 rdb 之后，再将新的写命令复制给 slave node。</li>
<li>如果在复制期间，内存缓冲区持续消耗超过 64MB，或者一次性超过 256MB，那么停止复制，复制失败。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client-output-buffer-limit slave 256MB 64MB <span class="number">60</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>slave node 接收到 rdb 之后，清空自己的旧数据，然后重新加载 rdb 到自己的内存中，同时基于旧的数据版本对外提供服务。</li>
<li>如果 slave node 开启了 AOF，那么会立即执行 BGREWRITEAOF，重写 AOF。</li>
</ul>
<h3 id="增量复制"><a href="#增量复制" class="headerlink" title="增量复制"></a>增量复制</h3><ul>
<li>如果全量复制过程中，master-slave 网络连接断掉，那么 slave 重新连接 master 时，会触发增量复制。</li>
<li>master 直接从自己的 backlog 中获取部分丢失的数据，发送给 slave node，默认 backlog 就是1MB。</li>
<li>msater就是根据 slave 发送的 psync 中的 offset 来从 backlog 中获取数据的。</li>
</ul>
<h3 id="heartbeat"><a href="#heartbeat" class="headerlink" title="heartbeat"></a>heartbeat</h3><p>主从节点互相都会发送 heartbeat 信息。</p>
<p>master 默认每隔 10秒 发送一次 heartbeat，slave node 每隔 1秒 发送一个 heartbeat。</p>
<h3 id="异步复制"><a href="#异步复制" class="headerlink" title="异步复制"></a>异步复制</h3><p>master 每次接收到写命令之后，先在内部写入数据，然后异步发送给 slave node。</p>
<h2 id="redis-如何才能做到高可用"><a href="#redis-如何才能做到高可用" class="headerlink" title="redis 如何才能做到高可用"></a>redis 如何才能做到高可用</h2><p>如果系统在 365 天内，有 99.99% 的时间，都是可以哗哗对外提供服务的，那么就说系统是高可用的。</p>
<p>一个 slave 挂掉了，是不会影响可用性的，还有其它的 slave 在提供相同数据下的相同的对外的查询服务。</p>
<p>但是，如果 master node 死掉了，会怎么样？没法写数据了，写缓存的时候，全部失效了。slave node 还有什么用呢，没有 master 给它们复制数据了，系统相当于不可用了。</p>
<p>redis 的高可用架构，叫做 <code>failover</code> 故障转移，也可以叫做主备切换。</p>
<p>master node 在故障时，自动检测，并且将某个 slave node 自动切换位 master node的过程，叫做主备切换。这个过程，实现了 redis 的主从架构下的高可用。</p>
<p>后面会详细说明 redis 基于哨兵的高可用性。</p>
<p>redis 实现高并发主要依靠主从架构，一主多从，一般来说，很多项目其实就足够了，单主用来写入数据，单机几万 QPS，多从用来查询数据，多个从实例可以提供每秒 10w 的 QPS。</p>
<p>如果想要在实现高并发的同时，容纳大量的数据，那么就需要 redis 集群，使用 redis 集群之后，可以提供每秒几十万的读写并发。</p>
<p>redis 高可用，如果是做主从架构部署，那么加上哨兵就可以了，就可以实现，任何一个实例宕机，可以进行主备切换。</p>
<h2 id="Redis基于哨兵模式实现高可用"><a href="#Redis基于哨兵模式实现高可用" class="headerlink" title="Redis基于哨兵模式实现高可用"></a>Redis基于哨兵模式实现高可用</h2><p>在开始本章的讲解之前，我们首先从宏观角度回顾一下 <a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/crs?from=20065&from_column=20065">Redis</a> 实现高可用相关的技术。它们包括：持久化、复制、哨兵和集群，在本系列的前篇文章介绍了持久化以及复制的原理以及实现。本文将对剩下的两种高可用技术哨兵、集群进行讲解，讲一讲它们是如何进一步提高系统的高可用性？</p>
<p>Redis 的主从复制模式下，一旦主节点由于故障不能提供服务，需要手动将从节点晋升为主节点，同时还要通知客户端更新主节点地址，这种故障处理方式从一定程度上是无法接受的。Redis 2.8 以后提供了 Redis Sentinel 哨兵机制来解决这个问题。</p>
<p>在 Redis 3.0 之前，使用哨兵（sentinel）机制来监控各个节点之间的状态。Redis Cluster 是 Redis 的分布式解决方案，在 3.0 版本正式推出，有效地解决了 Redis 在分布式方面的需求。当遇到单机内存、并发、流量等瓶颈时，可以采用 Cluster 架构方案达到<a target="_blank" rel="noopener" href="https://cloud.tencent.com/product/clb?from=20065&from_column=20065">负载均衡</a>的目的。</p>
<h2 id="Redis-HA-实践（Redis-Sentinel）"><a href="#Redis-HA-实践（Redis-Sentinel）" class="headerlink" title="Redis HA 实践（Redis Sentinel）"></a><strong>Redis HA 实践（Redis Sentinel）</strong></h2><h3 id="Redis-Sentinel-概述"><a href="#Redis-Sentinel-概述" class="headerlink" title="Redis Sentinel 概述"></a><strong>Redis Sentinel 概述</strong></h3><p>Sentinel（哨岗、哨兵）是 Redis 的高可用（high availability）解决方案：由一个或多个 Sentinel 实例（instance）组成的 Sentinel 系统（system）可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求。</p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/dy25zd7xc0.png" class title="img">

<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/uo069eiopx.png" class title="img">

<p>当 server1 的下线时长超过用户设定的下线时长上限时，Sentinel 系统就会对 server1 执行故障转移操作：</p>
<ul>
<li>首先，Sentinel 系统会挑选 server1 属下的其中一个从服务器，并将这个被选中的从服务升级为新的主服务器。</li>
<li>之后，Sentinel 系统会向 server1 属下的所有从服务器发送新的复制指令，让他们成为新的主服务器的从服务器，当所有从服务器都开始复制新的主服务器时，故障转移操作执行完毕。</li>
<li>另外，Sentinel 还会继续监视已下线的 server1，并在它重新上线时，将它设置为新的主服务器的从服务器。</li>
</ul>
<p>Sentinel 系统用于管理多个 Redis 服务器（instance）， 该系统执行以下三个任务：</p>
<ul>
<li>监控（Monitoring）：Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</li>
<li>提醒（Notification）：当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</li>
<li>自动故障迁移（Automatic failover）：当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器；当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</li>
</ul>
<h3 id="Redis-Sentinel-重点总结"><a href="#Redis-Sentinel-重点总结" class="headerlink" title="Redis Sentinel 重点总结"></a><strong>Redis Sentinel 重点总结</strong></h3><ul>
<li>Sentinel 只是一个运行在特殊模式下的 Redis 服务器，因此初始化服务器时将普通 Redis 服务器使用的代码替换成 Sentinel 专门代码，它使用了和普通模式不同的命令表，所以 Sentinel 模式能够使用的命令和普通 Redis 服务器能够使用的命令不同。</li>
<li>Sentinel 会读入用户指定的配置文件，为每个要被监视的主服务器创建相应的实例结构，并创建连向主服务器的命令连接和订阅连接，其中命令连接用于向主服务器发送命令请求，而订阅连接则用于接收指定频道的消息。</li>
<li>Sentinel 通过主服务器发送 INFO 命令来获得主服务器属下所有从服务器的地址信息，并为这些从服务器创建相应的实例结构，以及连向这些从服务器的命令连接和订阅连接。在一般情况下，Sentinel 以每十秒一次的频率向被监视的主服务器和从服务器发送 INFO 命令，当主服务器处于下线状态，或者 Sentinel 正在对主服务器进行故障转移操作时，Sentinel 向从服务器发送 INFO 命令的频率会改为每秒一次。</li>
<li>对于监视同一个主服务器和从服务器的多个 Sentinel 来说，它们会以每两秒一次的频率，通过向被监视服务器的 <em>sentinel</em>:hello 频道发送消息来向其他 Sentinel 宣告自己的存在。每个 Sentinel 也会从 <em>sentinel</em>:hello 频道中接收其他 Sentinel 发来的消息，并根据这些消息为其他 Sentinel 创建相应的实例结构以及命令连接。Sentinel 只会与主服务器和从服务器创建命令连接和订阅连接，Sentinel 与 Sentinel 之间则只创建命令连接。</li>
<li>Sentinel 以每秒一次的频率向实例（包括主服务器、从服务器、其他 Sentinel）发送 PING 命令，并根据实例对 PING 命令的回复来判断实例是否在线，当一个实例在指定的时长中连续向 Sentinel 发送无效回复时，Sentinel 会将这个实例判断为主观下线。</li>
<li>当 Sentinel 将一个主服务器判断为主观下线时，它会向同样监视这个主服务器的其它 Sentinel 进行询问，看它们是否同意这个主服务器已经进入主观下线状态。当 Sentinel 收集到足够多的的主观下线投票之后，它会将主服务器判断为客观下线，并发起一次针对主服务器的故障转移操作。</li>
<li>当一个主服务器被判断为客观下线时，监视这个下线主服务器的各个 Sentinel 会进行协商，选举出一个领头 Sentinel[1]，并由领头 Sentinel 对下线主服务器进行故障转移操作。</li>
</ul>
<h3 id="Redis-Sentinel-搭建"><a href="#Redis-Sentinel-搭建" class="headerlink" title="Redis Sentinel 搭建"></a><strong>Redis Sentinel 搭建</strong></h3><h4 id="Redis-Sentinel-部署技巧及其环境"><a href="#Redis-Sentinel-部署技巧及其环境" class="headerlink" title="Redis Sentinel 部署技巧及其环境"></a><strong>Redis Sentinel 部署技巧及其环境</strong></h4><ul>
<li>一个健壮的部署至少需要三个哨兵实例，并且使用奇数个 Sentinel。</li>
<li>三个哨兵实例应该放置在客户使用独立方式确认故障的计算机或虚拟机中，例如不同的物理机或不同可用区域的虚拟机。</li>
<li>哨兵配置文件中只需要配置主从复制中的主副本 ip 和端口即可，当主从进行切换时哨兵会自动修改哨兵配置文件中的主副本 ip 为新在主副本 ip。</li>
</ul>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/49c37tz8j9.png" class title="img">

<p>由于本人没有这么多服务器，因此在一台机器上模拟一个 Redis Sentinel 集群。</p>
<table>
<thead>
<tr>
<th align="left">角色</th>
<th align="left">IP 地址</th>
<th align="left">端口号</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Redis Master</td>
<td align="left">127.0.0.1</td>
<td align="left">6380</td>
</tr>
<tr>
<td align="left">Redis Slave-01</td>
<td align="left">127.0.0.1</td>
<td align="left">6381</td>
</tr>
<tr>
<td align="left">Redis Slave-02</td>
<td align="left">127.0.0.1</td>
<td align="left">6382</td>
</tr>
<tr>
<td align="left">Redis Slave-03</td>
<td align="left">127.0.0.1</td>
<td align="left">6383</td>
</tr>
<tr>
<td align="left">Redis Sentinel-01</td>
<td align="left">127.0.0.1</td>
<td align="left">26381</td>
</tr>
<tr>
<td align="left">Redis Sentinel-02</td>
<td align="left">127.0.0.1</td>
<td align="left">26382</td>
</tr>
<tr>
<td align="left">Redis Sentinel-03</td>
<td align="left">127.0.0.1</td>
<td align="left">26383</td>
</tr>
</tbody></table>
<h4 id="Redis-Sentinel-安装指南"><a href="#Redis-Sentinel-安装指南" class="headerlink" title="Redis Sentinel 安装指南"></a><strong>Redis Sentinel 安装指南</strong></h4><p>1、下载 Redis 服务软件包到服务器，解压后并编译安装。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# mkdir /usr/local/redis</span><br><span class="line">[root@VM_24_98_centos ~]# wget <span class="attr">http</span>:<span class="comment">//download.redis.io/releases/redis-5.0.6.tar.gz</span></span><br><span class="line">[root@VM_24_98_centos ~]# tar -zvxf redis-<span class="number">5.0</span><span class="number">.6</span>.<span class="property">tar</span>.<span class="property">gz</span> -C /usr/local/redis</span><br><span class="line">[root@VM_24_98_centos ~]# cd /usr/local/redis/redis-<span class="number">5.0</span><span class="number">.6</span>/</span><br><span class="line">[root@VM_24_98_centos redis-<span class="number">5.0</span><span class="number">.6</span>]# make <span class="variable constant_">PREFIX</span>=<span class="regexp">/usr/</span>local/redis install</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>2、设置 Redis 主服务器</p>
<p>a. 创建目录以及复制配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos redis]# mkdir -p /usr/local/redis/redis-master/redis-<span class="number">6380</span></span><br><span class="line">[root@VM_24_98_centos redis-master]# cp -r /usr/local/redis/redis-<span class="number">5.0</span><span class="number">.6</span>/redis.<span class="property">conf</span> /usr/local/redis/redis-master/redis-<span class="number">6380</span>/</span><br><span class="line">[root@VM_24_98_centos redis-master]# vim /usr/local/redis/redis-master/redis-<span class="number">6380</span>/redis.<span class="property">conf</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>b. 设置 Redis Master 主服务器配置环境</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 开启远程连接</span><br><span class="line">bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"># 端口号</span><br><span class="line">port <span class="number">6380</span></span><br><span class="line"># 守护进程</span><br><span class="line">daemonize yes</span><br><span class="line"># 进程文件</span><br><span class="line">pidfile /usr/local/redis/redis-master/redis-<span class="number">6380</span>/redis.<span class="property">pid</span></span><br><span class="line"># 日志文件</span><br><span class="line">logfile /usr/local/redis/redis-master/redis-<span class="number">6380</span>/redis.<span class="property">log</span></span><br><span class="line"># 工作目录</span><br><span class="line">dir /usr/local/redis/redis-master/redis-<span class="number">6380</span>/</span><br><span class="line"># 主服务器密码</span><br><span class="line">masterauth foobared</span><br><span class="line"># 认证密码</span><br><span class="line">requirepass foobared</span><br><span class="line"># 开启 <span class="variable constant_">AOF</span> 持久化</span><br><span class="line">appendonly yes</span><br><span class="line"># 每秒调用一次 fsync</span><br><span class="line">appendfsync everysec</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>c. 启动 Redis Master 主服务器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos redis-<span class="number">6380</span>]# /usr/local/redis/bin/redis-server /usr/local/redis/redis-master/redis-<span class="number">6380</span>/redis.<span class="property">conf</span></span><br><span class="line">[root@VM_24_98_centos redis-<span class="number">6380</span>]# ps -ef |grep redis</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>d. 客户端测试连接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-server /usr/local/redis/redis-master/redis-<span class="number">6380</span>/redis.<span class="property">conf</span></span><br><span class="line"></span><br><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6380</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6380</span>&gt; <span class="variable constant_">INFO</span> <span class="variable constant_">REPLICATION</span></span><br><span class="line"># <span class="title class_">Replication</span></span><br><span class="line"><span class="attr">role</span>:master</span><br><span class="line"><span class="attr">connected_slaves</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">master_replid</span>:5c1034ac4dec31d6a4ae883e1eaacca3a78bc3b6</span><br><span class="line"><span class="attr">master_replid2</span>:<span class="number">0000000000000000000000000000000000000000</span></span><br><span class="line"><span class="attr">master_repl_offset</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">second_repl_offset</span>:-<span class="number">1</span></span><br><span class="line"><span class="attr">repl_backlog_active</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">repl_backlog_size</span>:<span class="number">1048576</span></span><br><span class="line"><span class="attr">repl_backlog_first_byte_offset</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">repl_backlog_histlen</span>:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>3、设置 Redis 从服务器</p>
<p>a. 创建目录以及复制配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos redis]# mkdir -p /usr/local/redis/redis-slave/redis-<span class="number">6381</span></span><br><span class="line">[root@VM_24_98_centos redis-slave]# cp -r /usr/local/redis/redis-<span class="number">5.0</span><span class="number">.6</span>/redis.<span class="property">conf</span> /usr/local/redis/redis-slave/redis-<span class="number">6381</span>/</span><br><span class="line">[root@VM_24_98_centos redis-slave]# vim /usr/local/redis/redis-slave/redis-<span class="number">6381</span>/redis.<span class="property">conf</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>b. 设置 Redis Slave 从服务器配置环境</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># 开启远程连接</span><br><span class="line">bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"># 端口号</span><br><span class="line">port <span class="number">6381</span></span><br><span class="line"># 守护进程</span><br><span class="line">daemonize yes</span><br><span class="line"># 进程文件</span><br><span class="line">pidfile /usr/local/redis/redis-slave/redis-<span class="number">6381</span>/redis.<span class="property">pid</span></span><br><span class="line"># 日志文件</span><br><span class="line">logfile /usr/local/redis/redis-slave/redis-<span class="number">6381</span>/redis.<span class="property">log</span></span><br><span class="line"># 工作目录</span><br><span class="line">dir /usr/local/redis/redis-slave/redis-<span class="number">6381</span>/</span><br><span class="line"># 主从复制 <span class="title class_">Master</span> 节点地址 + 端口</span><br><span class="line">replicaof <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6380</span></span><br><span class="line"># 主服务器密码</span><br><span class="line">masterauth foobared</span><br><span class="line"># 认证密码</span><br><span class="line">requirepass foobared</span><br><span class="line"># 开启 <span class="variable constant_">AOF</span> 持久化</span><br><span class="line">appendonly yes</span><br><span class="line"># 每秒调用一次 fsync</span><br><span class="line">appendfsync everysec</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>c. 启动 Redis Slave 从服务器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos redis-<span class="number">6381</span>]# /usr/local/redis/bin/redis-server /usr/local/redis/redis-slave/redis-<span class="number">6381</span>/redis.<span class="property">conf</span></span><br><span class="line">[root@VM_24_98_centos redis-<span class="number">6381</span>]# ps -ef |grep redis</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>d. 客户端测试连接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-server /usr/local/redis/redis-slave/redis-<span class="number">6381</span>/redis.<span class="property">conf</span></span><br><span class="line"></span><br><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6381</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6381</span>&gt; <span class="variable constant_">INFO</span> <span class="variable constant_">REPLICATION</span></span><br><span class="line"># <span class="title class_">Replication</span></span><br><span class="line"><span class="attr">role</span>:slave</span><br><span class="line"><span class="attr">master_host</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">master_port</span>:<span class="number">6380</span></span><br><span class="line"><span class="attr">master_link_status</span>:up</span><br><span class="line"><span class="attr">master_last_io_seconds_ago</span>:<span class="number">5</span></span><br><span class="line"><span class="attr">master_sync_in_progress</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">slave_repl_offset</span>:<span class="number">14</span></span><br><span class="line"><span class="attr">slave_priority</span>:<span class="number">100</span></span><br><span class="line"><span class="attr">slave_read_only</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">connected_slaves</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">master_replid</span>:8ecb8d89dba51e54aabb1c7feeda42fe6e6a8dc0</span><br><span class="line"><span class="attr">master_replid2</span>:<span class="number">0000000000000000000000000000000000000000</span></span><br><span class="line"><span class="attr">master_repl_offset</span>:<span class="number">14</span></span><br><span class="line"><span class="attr">second_repl_offset</span>:-<span class="number">1</span></span><br><span class="line"><span class="attr">repl_backlog_active</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">repl_backlog_size</span>:<span class="number">1048576</span></span><br><span class="line"><span class="attr">repl_backlog_first_byte_offset</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">repl_backlog_histlen</span>:<span class="number">14</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>e. 同理，从服务器 redis-6382、redis-6383 按照上面的步骤部署。</p>
<p>4、Redis Sentinel 部署</p>
<p>a. 创建目录以及复制配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos redis]# mkdir -p /usr/local/redis/redis-sentinel/redis-<span class="number">26381</span></span><br><span class="line">[root@VM_24_98_centos redis-sentinel]# cp -r /usr/local/redis/redis-<span class="number">5.0</span><span class="number">.6</span>/sentinel.<span class="property">conf</span> /usr/local/redis/redis-sentinel/redis-<span class="number">26381</span>/</span><br><span class="line">[root@VM_24_98_centos redis-sentinel]# vim /usr/local/redis/redis-sentinel/redis-<span class="number">26381</span>/sentinel.<span class="property">conf</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>b. 设置 Redis Sentinel 哨兵服务器配置环境</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 端口号</span><br><span class="line">port <span class="number">26381</span></span><br><span class="line"># 守护进程</span><br><span class="line">daemonize yes</span><br><span class="line"># 进程文件</span><br><span class="line">pidfile /usr/local/redis/redis-sentinel/redis-<span class="number">26381</span>/redis.<span class="property">pid</span></span><br><span class="line"># 日志文件</span><br><span class="line">logfile /usr/local/redis/redis-sentinel/redis-<span class="number">26381</span>/redis.<span class="property">log</span></span><br><span class="line"># 工作目录</span><br><span class="line">dir /usr/local/redis/redis-sentinel/redis-<span class="number">26381</span>/</span><br><span class="line"># 指定监控 master&#123;<span class="number">2</span> 表示多少个 sentinel 同意&#125;</span><br><span class="line">sentinel monitor mymaster <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">6380</span> <span class="number">2</span></span><br><span class="line"># 安全信息</span><br><span class="line">sentinel auth-pass mymaster foobared</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>c. 启动 Redis Sentinel 哨兵服务器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos redis-<span class="number">26381</span>]# /usr/local/redis/bin/redis-sentinel /usr/local/redis/redis-sentinel/redis-<span class="number">26381</span>/sentinel.<span class="property">conf</span></span><br><span class="line">[root@VM_24_98_centos redis-<span class="number">26381</span>]# ps -ef |grep redis</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>d. 客户端测试连接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">26381</span></span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">26381</span>&gt; <span class="variable constant_">INFO</span> <span class="variable constant_">SENTINEL</span></span><br><span class="line"># <span class="title class_">Sentinel</span></span><br><span class="line"><span class="attr">sentinel_masters</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">sentinel_tilt</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">sentinel_running_scripts</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">sentinel_scripts_queue_length</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">sentinel_simulate_failure_flags</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">master0</span>:name=mymaster,status=ok,address=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6380</span>,slaves=<span class="number">3</span>,sentinels=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>e. 同理，哨兵服务器 redis-26382、redis-26383 按照上面的步骤部署</p>
<p>f. 查看 Redis Master 主服务器连接状况</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6380</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6380</span>&gt; <span class="variable constant_">INFO</span> <span class="variable constant_">REPLICATION</span></span><br><span class="line"># <span class="title class_">Replication</span></span><br><span class="line"><span class="attr">role</span>:master</span><br><span class="line"><span class="attr">connected_slaves</span>:<span class="number">3</span></span><br><span class="line"><span class="attr">slave0</span>:ip=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>,port=<span class="number">6383</span>,state=online,offset=<span class="number">20836</span>,lag=<span class="number">0</span></span><br><span class="line"><span class="attr">slave1</span>:ip=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>,port=<span class="number">6381</span>,state=online,offset=<span class="number">20836</span>,lag=<span class="number">0</span></span><br><span class="line"><span class="attr">slave2</span>:ip=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>,port=<span class="number">6382</span>,state=online,offset=<span class="number">20836</span>,lag=<span class="number">0</span></span><br><span class="line"><span class="attr">master_replid</span>:cc8ef3fe2e51a714f5b73b2fbe3bd697cacbc453</span><br><span class="line"><span class="attr">master_replid2</span>:8ecb8d89dba51e54aabb1c7feeda42fe6e6a8dc0</span><br><span class="line"><span class="attr">master_repl_offset</span>:<span class="number">20836</span></span><br><span class="line"><span class="attr">second_repl_offset</span>:<span class="number">1522</span></span><br><span class="line"><span class="attr">repl_backlog_active</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">repl_backlog_size</span>:<span class="number">1048576</span></span><br><span class="line"><span class="attr">repl_backlog_first_byte_offset</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">repl_backlog_histlen</span>:<span class="number">20836</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<h3 id="Redis-Sentinel-场景测试"><a href="#Redis-Sentinel-场景测试" class="headerlink" title="Redis Sentinel 场景测试"></a><strong>Redis Sentinel 场景测试</strong></h3><p>模拟场景：Redis Master 节点挂掉，查看 Redis 集群状态。</p>
<p>Step1、关掉 Master 节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6380</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6380</span>&gt; <span class="variable constant_">SHUTDOWN</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>Step2、通过哨兵查看集群状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">26381</span></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">26381</span>&gt; <span class="variable constant_">INFO</span> <span class="variable constant_">SENTINEL</span></span><br><span class="line"># <span class="title class_">Sentinel</span></span><br><span class="line"><span class="attr">sentinel_masters</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">sentinel_tilt</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">sentinel_running_scripts</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">sentinel_scripts_queue_length</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">sentinel_simulate_failure_flags</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">master0</span>:name=mymaster,status=ok,address=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6381</span>,slaves=<span class="number">3</span>,sentinels=<span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>通过 Sentinel 信息可以看到，Master 节点已经自动切换到 6381 端口了，说明主节点挂掉后，6381 Slave 节点自动升级成为了 Master 节点。</p>
<p>通过 Sentinel 日志文件显示了 failover 的过程：</p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/it3cdc8xvp.png" class title="img">

<p>Step3、启动 6380 Redis 服务，然后查看节点角色，此时 6380 变成了 Slave，6381 为 Master 节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-server /usr/local/redis/redis-master/redis-<span class="number">6380</span>/redis.<span class="property">conf</span></span><br><span class="line"></span><br><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6380</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6380</span>&gt; <span class="variable constant_">INFO</span> <span class="variable constant_">REPLICATION</span></span><br><span class="line"># <span class="title class_">Replication</span></span><br><span class="line"><span class="attr">role</span>:slave</span><br><span class="line"><span class="attr">master_host</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"><span class="attr">master_port</span>:<span class="number">6381</span></span><br><span class="line"><span class="attr">master_link_status</span>:up</span><br><span class="line"><span class="attr">master_last_io_seconds_ago</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">master_sync_in_progress</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">slave_repl_offset</span>:<span class="number">782228</span></span><br><span class="line"><span class="attr">slave_priority</span>:<span class="number">100</span></span><br><span class="line"><span class="attr">slave_read_only</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">connected_slaves</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">master_replid</span>:84aa69ee0b191bba31162c26c4ddb1c87a705f7e</span><br><span class="line"><span class="attr">master_replid2</span>:<span class="number">0000000000000000000000000000000000000000</span></span><br><span class="line"><span class="attr">master_repl_offset</span>:<span class="number">782228</span></span><br><span class="line"><span class="attr">second_repl_offset</span>:-<span class="number">1</span></span><br><span class="line"><span class="attr">repl_backlog_active</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">repl_backlog_size</span>:<span class="number">1048576</span></span><br><span class="line"><span class="attr">repl_backlog_first_byte_offset</span>:<span class="number">777789</span></span><br><span class="line"><span class="attr">repl_backlog_histlen</span>:<span class="number">4440</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<h2 id="Redis-HA-实践（Redis-Cluster）"><a href="#Redis-HA-实践（Redis-Cluster）" class="headerlink" title="Redis HA 实践（Redis Cluster）"></a><strong>Redis HA 实践（Redis Cluster）</strong></h2><h3 id="Redis-Cluster-概述"><a href="#Redis-Cluster-概述" class="headerlink" title="Redis Cluster 概述"></a><strong>Redis Cluster 概述</strong></h3><p>Redis 集群是 Redis 提供的分布式<a target="_blank" rel="noopener" href="https://cloud.tencent.com/solution/database?from=20065&from_column=20065">数据库</a>方案，集群通过分片（sharding）而非一致性哈希（consistency hashing）来进行数据分享，并提供复制和故障转移功能。Redis Cluster，主要是针对海量数据 + 高并发 + 高可用的场景。Redis Cluster 支撑 N 个 Redis Master Node，每个 Master Node 都可以挂载多个 Slave Node。Redis Cluster 节点间采用 Gossip 协议[2]进行通信。</p>
<p>节点：一个 Redis 集群通常由多个节点（node）组成，连接各个节点的工作可以使用 CLUSTER MEET <ip> <port> 命令来完成，将各个独立的节点连接起来，构成一个包含多个节点的集群。向一个节点 node 发送 CLUSTER MEET 命令，可以让 node 节点与 ip 和 port 所指定的节点进行握手（handshake），当握手成功时，node 节点就会将 ip 和 port 所指定的节点添加到 node 节点当前所在的集群中。</port></ip></p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/7eyyyn1obp.png" class title="img">

<p><strong>槽指派</strong>：Redis 集群通过分片的方式来保存数据库中的键值对，集群的整数据库被分为 16384 个槽（slot），数据库中的每个键都属于这 16384 个槽的其中一个，集群中的每个节点可以处理 0 个或最多 16384 个槽。Redis 集群有固定的 16384 个 hash slot，对每个 key 计算 CRC16 值，然后对 16384 取模，可以获取 key 对应的 hash slot。当数据库中的 16384 个槽都有节点在处理时，集群处于上线状态（ok）；相反地，如果数据库中任何一个槽没有得到处理，那么集群处于下线状态（fail）。</p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/808e3izvdh.png" class title="img">

<h3 id="Redis-Cluster-重点总结"><a href="#Redis-Cluster-重点总结" class="headerlink" title="Redis Cluster 重点总结"></a><strong>Redis Cluster 重点总结</strong></h3><ul>
<li>节点通过握手来将其他节点添加到自己所处的集群当中。</li>
<li>集群中的 16384（2的14次方）个槽可以分别指派给集群中的各个节点，每个节点都会记录哪些槽指派给了自己，而哪些槽又被指派给其他节点。</li>
<li>节点在接到一个命令请求时，会先检查这个命令请求要处理的键所在的槽是否由自己负责，如果不是的话，节点将向客户端返回一个 MOVED 错误，MOVED 错误携带的信息可以指引客户端转向至正在负责相关槽的节点。</li>
<li>对 Redis 集群的重新分片工作是由 redis-trib 负责执行的，重新分片的关键是将属于某个槽的所有键值对从一个节点转移至另外一个节点。重新分片操作可以在线（online）进行，在重新分片的过程中，集群不需要下线，并且源节点和目标节点都可以继续处理命令请求。</li>
<li>如果节点 A 正在迁移槽 i 至节点 B，那么当节点 A 没能在自己的数据库中找到命令指定的数据库键时，节点 A 会向客户端返回一个 ASK 错误，指引客户端到节点 B 继续查找指定的数据库键。</li>
<li>MOVED 错误表示槽的负责权已经从一个节点转移到了另外一个节点，而 ASK 错误只是两个节点在迁移槽的过程中使用的一种临时措施。</li>
<li>Redis 集群中的节点分为主节点（master）和从节点（slave），其中主节点用于处理槽，而从节点用于复制主节点，并在主节点下线时，代替主节点继续处理命令请求。</li>
<li>集群中的节点通过发送和接收消息来进行通信，常见的消息包括 MEET、PING、PONG、PUBLISH、FAIL 五种。</li>
</ul>
<h3 id="Redis-Cluster-与-Redis-Sentinel-区别"><a href="#Redis-Cluster-与-Redis-Sentinel-区别" class="headerlink" title="Redis Cluster 与 Redis Sentinel 区别"></a><strong>Redis Cluster 与 Redis Sentinel 区别</strong></h3><ul>
<li>哨兵模式监控权交给了哨兵系统，集群模式中是工作节点自己做监控。</li>
<li>哨兵模式发起选举是选举一个 leader 哨兵节点来处理故障转移，集群模式是在从节点中选举一个新的主节点，来处理故障的转移。</li>
</ul>
<h3 id="Redis-Cluster-搭建"><a href="#Redis-Cluster-搭建" class="headerlink" title="Redis Cluster 搭建"></a><strong>Redis Cluster 搭建</strong></h3><h4 id="Redis-Cluster-部署技巧及其环境"><a href="#Redis-Cluster-部署技巧及其环境" class="headerlink" title="Redis Cluster 部署技巧及其环境"></a><strong>Redis Cluster 部署技巧及其环境</strong></h4><ul>
<li>Redis 集群至少需要 3 个节点，因为投票容错机制要求超过半数节点认为某个节点挂了该节点才是挂了，所以 2 个节点无法构成集群。</li>
<li>要保证集群的高可用，需要每个节点都有从节点，也就是备份节点，即三主三从，所以 Redis 集群至少需要 6 台服务器。</li>
<li>Redis 5.0 开始不再使用 Ruby 搭建集群，而是直接使用客户端命令 redis-cli 来创建。</li>
<li>不支持多数据库空间，集群模式下只能使用 db0 空间。</li>
</ul>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/k8zcq5yvs2.png" class title="img">

<p>由于资源有限，因此在一台机器上模拟一个 Redis Cluster。</p>
<table>
<thead>
<tr>
<th align="left">角色</th>
<th align="left">IP 地址</th>
<th align="left">端口号</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Redis Cluster-Master-01-6391</td>
<td align="left">127.0.0.1</td>
<td align="left">6391</td>
</tr>
<tr>
<td align="left">Redis Cluster-Master-02-6393</td>
<td align="left">127.0.0.1</td>
<td align="left">6393</td>
</tr>
<tr>
<td align="left">Redis Cluster-Master-02-6395</td>
<td align="left">127.0.0.1</td>
<td align="left">6395</td>
</tr>
<tr>
<td align="left">Redis Cluster-Slave-01-6394</td>
<td align="left">127.0.0.1</td>
<td align="left">6394</td>
</tr>
<tr>
<td align="left">Redis Cluster-Slave-02-6396</td>
<td align="left">127.0.0.1</td>
<td align="left">6396</td>
</tr>
<tr>
<td align="left">Redis Cluster-Slave-03-6392</td>
<td align="left">127.0.0.1</td>
<td align="left">6392</td>
</tr>
</tbody></table>
<h4 id="Redis-Cluster-安装指南"><a href="#Redis-Cluster-安装指南" class="headerlink" title="Redis Cluster 安装指南"></a><strong>Redis Cluster 安装指南</strong></h4><p>1、下载 Redis 服务软件包到服务器，解压后并编译安装。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# mkdir /usr/local/redis</span><br><span class="line">[root@VM_24_98_centos ~]# wget <span class="attr">http</span>:<span class="comment">//download.redis.io/releases/redis-5.0.6.tar.gz</span></span><br><span class="line">[root@VM_24_98_centos ~]# tar -zvxf redis-<span class="number">5.0</span><span class="number">.6</span>.<span class="property">tar</span>.<span class="property">gz</span> -C /usr/local/redis</span><br><span class="line">[root@VM_24_98_centos ~]# cd /usr/local/redis/redis-<span class="number">5.0</span><span class="number">.6</span>/</span><br><span class="line">[root@VM_24_98_centos redis-<span class="number">5.0</span><span class="number">.6</span>]# make <span class="variable constant_">PREFIX</span>=<span class="regexp">/usr/</span>local/redis install</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>2、设置 Redis Cluster 服务器</p>
<p>a. 创建目录以及复制配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# mkdir -p /usr/local/redis/redis-cluster/redis-<span class="number">6391</span></span><br><span class="line">[root@VM_24_98_centos ~]# cp -r /usr/local/redis/redis-<span class="number">5.0</span><span class="number">.6</span>/redis.<span class="property">conf</span> /usr/local/redis/redis-cluster/redis-<span class="number">6391</span>/</span><br><span class="line">[root@VM_24_98_centos ~]# vim /usr/local/redis/redis-cluster/redis-<span class="number">6391</span>/redis.<span class="property">conf</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>b. 设置 Redis Cluster 服务器配置环境</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 开启远程连接</span><br><span class="line">bind <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"># </span><br><span class="line">protected-mode no</span><br><span class="line"># 端口号</span><br><span class="line">port <span class="number">6391</span></span><br><span class="line"># 守护进程</span><br><span class="line">daemonize yes</span><br><span class="line"># 进程文件</span><br><span class="line">pidfile /usr/local/redis/redis-cluster/redis-<span class="number">6391</span>/redis.<span class="property">pid</span></span><br><span class="line"># 日志文件</span><br><span class="line">logfile /usr/local/redis/redis-cluster/redis-<span class="number">6391</span>/redis.<span class="property">log</span></span><br><span class="line"># 工作目录</span><br><span class="line">dir /usr/local/redis/redis-cluster/redis-<span class="number">6391</span>/</span><br><span class="line"># 主服务器密码</span><br><span class="line">masterauth foobared</span><br><span class="line"># 认证密码</span><br><span class="line">requirepass foobared</span><br><span class="line"># 开启 <span class="variable constant_">AOF</span> 持久化</span><br><span class="line">appendonly yes</span><br><span class="line"># 每秒调用一次 fsync</span><br><span class="line">appendfsync everysec</span><br><span class="line"># 开启集群</span><br><span class="line">cluster-enabled yes</span><br><span class="line"># 集群的配置文件，首次启动会自动创建</span><br><span class="line">cluster-config-file nodes.<span class="property">conf</span></span><br><span class="line"># 集群节点连接超时时间，<span class="number">15</span>秒</span><br><span class="line">cluster-node-timeout <span class="number">15000</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>c. 启动 Redis Cluster 服务器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-server /usr/local/redis/redis-cluster/redis-<span class="number">6391</span>/redis.<span class="property">conf</span></span><br><span class="line">[root@VM_24_98_centos ~]# ps -ef |grep redis</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>d. 客户端测试连接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-server /usr/local/redis/redis-cluster/redis-<span class="number">6391</span>/redis.<span class="property">conf</span></span><br><span class="line"></span><br><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6391</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>&gt; <span class="variable constant_">CLUSTER</span> <span class="variable constant_">INFO</span></span><br><span class="line"><span class="attr">cluster_state</span>:fail</span><br><span class="line"><span class="attr">cluster_slots_assigned</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_slots_ok</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_slots_pfail</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_slots_fail</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_known_nodes</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">cluster_size</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_current_epoch</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_my_epoch</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_stats_messages_sent</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_stats_messages_received</span>:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>e. 同理，集群服务器 redis-6392、redis-6393 、redis-6394、redis-6395、redis-6396 按照上面的步骤部署</p>
<p>3、Redis 5.0 开始不再使用 ruby 搭建集群，而是直接使用客户端命令 redis-cli 来创建。</p>
<p>a. 创建顺序三主三从，前面三个是主后面三个是从。由于我们设置了redis集群的密码，所以要带上密码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli --cluster create <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6393</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6395</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6392</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6394</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6396</span> --cluster-replicas <span class="number">1</span> -a foobared</span><br></pre></td></tr></table></figure>

<p>复制</p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/9n5cusr6j9.png" class title="img">

<p>b. 客户端测试连接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6391</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>&gt; <span class="variable constant_">CLUSTER</span> <span class="variable constant_">INFO</span></span><br><span class="line"><span class="attr">cluster_state</span>:ok</span><br><span class="line"><span class="attr">cluster_slots_assigned</span>:<span class="number">16384</span></span><br><span class="line"><span class="attr">cluster_slots_ok</span>:<span class="number">16384</span></span><br><span class="line"><span class="attr">cluster_slots_pfail</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_slots_fail</span>:<span class="number">0</span></span><br><span class="line"><span class="attr">cluster_known_nodes</span>:<span class="number">6</span></span><br><span class="line"><span class="attr">cluster_size</span>:<span class="number">3</span></span><br><span class="line"><span class="attr">cluster_current_epoch</span>:<span class="number">6</span></span><br><span class="line"><span class="attr">cluster_my_epoch</span>:<span class="number">1</span></span><br><span class="line"><span class="attr">cluster_stats_messages_ping_sent</span>:<span class="number">1153</span></span><br><span class="line"><span class="attr">cluster_stats_messages_pong_sent</span>:<span class="number">1241</span></span><br><span class="line"><span class="attr">cluster_stats_messages_sent</span>:<span class="number">2394</span></span><br><span class="line"><span class="attr">cluster_stats_messages_ping_received</span>:<span class="number">1236</span></span><br><span class="line"><span class="attr">cluster_stats_messages_pong_received</span>:<span class="number">1153</span></span><br><span class="line"><span class="attr">cluster_stats_messages_meet_received</span>:<span class="number">5</span></span><br><span class="line"><span class="attr">cluster_stats_messages_received</span>:<span class="number">2394</span></span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>&gt; <span class="variable constant_">CLUSTER</span> <span class="variable constant_">NODES</span></span><br><span class="line">cdfd726c3c35586770412cade1fe5c56d4285b0e <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6394</span>@<span class="number">16394</span> slave c54ebef126b30b5bd9cb157ccc0b6ddb952a1f50 <span class="number">0</span> <span class="number">1574234724000</span> <span class="number">5</span> connected</span><br><span class="line">c8daea9291a5cfdf0b3e032bc3a80d7e3cbc75cc <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6393</span>@<span class="number">16393</span> master - <span class="number">0</span> <span class="number">1574234725711</span> <span class="number">2</span> connected <span class="number">5461</span>-<span class="number">10922</span></span><br><span class="line">43c325955c74f0ed79de6850dca8a509195acb13 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6392</span>@<span class="number">16392</span> slave 718f66ab8b3574597a97b90f8257773d0483c556 <span class="number">0</span> <span class="number">1574234724000</span> <span class="number">4</span> connected</span><br><span class="line">3a32043079bf6af3723230ee3e6412e84dd66180 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6396</span>@<span class="number">16396</span> slave c8daea9291a5cfdf0b3e032bc3a80d7e3cbc75cc <span class="number">0</span> <span class="number">1574234724708</span> <span class="number">6</span> connected</span><br><span class="line">c54ebef126b30b5bd9cb157ccc0b6ddb952a1f50 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>@<span class="number">16391</span> myself,master - <span class="number">0</span> <span class="number">1574234725000</span> <span class="number">1</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br><span class="line">718f66ab8b3574597a97b90f8257773d0483c556 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6395</span>@<span class="number">16395</span> master - <span class="number">0</span> <span class="number">1574234723000</span> <span class="number">3</span> connected <span class="number">10923</span>-<span class="number">16383</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p><strong>Redis Cluster 场景测试</strong></p>
<p>（1）模拟场景：Redis Cluster 中 某个 Master 节点挂掉，查看 Redis Cluster 状态。</p>
<p>Step1、关掉 Cluster-Master-6391 节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6391</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>&gt; <span class="variable constant_">SHUTDOWN</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>Step2、查看集群状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6393</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6393</span>&gt; <span class="variable constant_">CLUSTER</span> <span class="variable constant_">NODES</span></span><br><span class="line">43c325955c74f0ed79de6850dca8a509195acb13 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6392</span>@<span class="number">16392</span> slave 718f66ab8b3574597a97b90f8257773d0483c556 <span class="number">0</span> <span class="number">1574236204772</span> <span class="number">4</span> connected</span><br><span class="line">3a32043079bf6af3723230ee3e6412e84dd66180 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6396</span>@<span class="number">16396</span> slave c8daea9291a5cfdf0b3e032bc3a80d7e3cbc75cc <span class="number">0</span> <span class="number">1574236206778</span> <span class="number">6</span> connected</span><br><span class="line">cdfd726c3c35586770412cade1fe5c56d4285b0e <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6394</span>@<span class="number">16394</span> master - <span class="number">0</span> <span class="number">1574236201000</span> <span class="number">7</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br><span class="line">718f66ab8b3574597a97b90f8257773d0483c556 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6395</span>@<span class="number">16395</span> master - <span class="number">0</span> <span class="number">1574236206000</span> <span class="number">3</span> connected <span class="number">10923</span>-<span class="number">16383</span></span><br><span class="line">c54ebef126b30b5bd9cb157ccc0b6ddb952a1f50 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>@<span class="number">16391</span> master,fail - <span class="number">1574236049092</span> <span class="number">1574236047289</span> <span class="number">1</span> disconnected</span><br><span class="line">c8daea9291a5cfdf0b3e032bc3a80d7e3cbc75cc <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6393</span>@<span class="number">16393</span> myself,master - <span class="number">0</span> <span class="number">1574236204000</span> <span class="number">2</span> connected <span class="number">5461</span>-<span class="number">10922</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>通过 CLUSTER NODES 信息可以看到，Cluster-Master-01-6391 主节点处于下线状态（fail），其 Cluster-Master-01-6391 节点的从节点 Cluster-Slave-01-6394 变为主节点；说明主节点挂掉后，6394 Slave 节点自动升级成为了 Master 节点。</p>
<p>Step3、启动 6391 Redis 服务，然后查看节点角色，此时 6391 变成了 Slave，6394 为 Master 节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-server /usr/local/redis/redis-cluster/redis-<span class="number">6391</span>/redis.<span class="property">conf</span></span><br><span class="line"></span><br><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6391</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>&gt; <span class="variable constant_">CLUSTER</span> <span class="variable constant_">NODES</span></span><br><span class="line">43c325955c74f0ed79de6850dca8a509195acb13 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6392</span>@<span class="number">16392</span> slave 718f66ab8b3574597a97b90f8257773d0483c556 <span class="number">0</span> <span class="number">1574238264397</span> <span class="number">4</span> connected</span><br><span class="line">c54ebef126b30b5bd9cb157ccc0b6ddb952a1f50 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>@<span class="number">16391</span> myself,slave cdfd726c3c35586770412cade1fe5c56d4285b0e <span class="number">0</span> <span class="number">1574238261000</span> <span class="number">1</span> connected</span><br><span class="line">3a32043079bf6af3723230ee3e6412e84dd66180 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6396</span>@<span class="number">16396</span> slave c8daea9291a5cfdf0b3e032bc3a80d7e3cbc75cc <span class="number">0</span> <span class="number">1574238265400</span> <span class="number">6</span> connected</span><br><span class="line">c8daea9291a5cfdf0b3e032bc3a80d7e3cbc75cc <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6393</span>@<span class="number">16393</span> master - <span class="number">0</span> <span class="number">1574238263000</span> <span class="number">2</span> connected <span class="number">5461</span>-<span class="number">10922</span></span><br><span class="line">718f66ab8b3574597a97b90f8257773d0483c556 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6395</span>@<span class="number">16395</span> master - <span class="number">0</span> <span class="number">1574238263000</span> <span class="number">3</span> connected <span class="number">10923</span>-<span class="number">16383</span></span><br><span class="line">cdfd726c3c35586770412cade1fe5c56d4285b0e <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6394</span>@<span class="number">16394</span> master - <span class="number">0</span> <span class="number">1574238264000</span> <span class="number">7</span> connected <span class="number">0</span>-<span class="number">5460</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>（2）模拟场景：为 Redis Cluster 添加一个新主（master）节点</p>
<p>Step1、按照上面的步骤新增一 Redis Cluster 服务器 Cluster-Master-04-6397</p>
<p>Step2、将 Cluster-Master-04-6397 节点加入 Redis Cluster 中（127.0.0.1:6391 为集群中任意可用的节点）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli --cluster add-node <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6397</span>  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>  -a foobared</span><br></pre></td></tr></table></figure>

<p>复制</p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/n11rtq4vp6.png" class title="img">

<p><strong>Step3、为节点 Cluster-Master-04-6397 分配 slots（127.0.0.1:6391 为集群中任意可用的节点）</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos redis-cluster]# /usr/local/redis/bin/redis-cli --cluster reshard <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span> -a foobared</span><br></pre></td></tr></table></figure>

<p>复制</p>
<img src="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81-redis-%E7%9A%84%E9%AB%98%E5%B9%B6%E5%8F%91%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%EF%BC%9F/lj99ax1xuh.png" class title="img">

<p>（3）模拟场景：为 Redis Cluster 某个 Master 节点添加 一个新从（slave）节点</p>
<p>Step1、按照上面的步骤新增一 Redis Cluster 服务器 Cluster-Slave-04-6398</p>
<p>Step2、将 Cluster-Slave-04-6398 节点加入 Redis Cluster 中（127.0.0.1:6391 为集群中任意可用的节点）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这种方法随机为 6398 指定一个 master</span></span><br><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli --cluster add-node <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6398</span>  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span> --cluster-slave -a foobared</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这种方式将为 6398 指定某个 master-id</span></span><br><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli --cluster add-node <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6398</span>  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span> --cluster-slave --cluster-master-id 5cf471cf39f0104f69d06c80d0dfdcc8aaa96b7c -a foobared</span><br></pre></td></tr></table></figure>

<p>复制</p>
<p>Step3、查看集群状态</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_98_centos ~]# /usr/local/redis/bin/redis-cli -h <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">6391</span> -a  foobared</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>&gt; <span class="variable constant_">CLUSTER</span> <span class="variable constant_">NODES</span></span><br><span class="line">5cf471cf39f0104f69d06c80d0dfdcc8aaa96b7c <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6397</span>@<span class="number">16397</span> master - <span class="number">0</span> <span class="number">1574243297701</span> <span class="number">7</span> connected <span class="number">0</span>-<span class="number">1364</span> <span class="number">5461</span>-<span class="number">6826</span> <span class="number">10923</span>-<span class="number">12287</span></span><br><span class="line">207628f6fb8b3bb9a22db757507350fb880d4990 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6396</span>@<span class="number">16396</span> slave 94af5d349465be57400b6a4a1d770d56ad3d94ce <span class="number">0</span> <span class="number">1574243294000</span> <span class="number">6</span> connected</span><br><span class="line">94af5d349465be57400b6a4a1d770d56ad3d94ce <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6393</span>@<span class="number">16393</span> master - <span class="number">0</span> <span class="number">1574243296700</span> <span class="number">2</span> connected <span class="number">6827</span>-<span class="number">10922</span></span><br><span class="line">2e0134b0a87a73903d4774b6b37dd43e78e93733 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6391</span>@<span class="number">16391</span> myself,master - <span class="number">0</span> <span class="number">1574243292000</span> <span class="number">1</span> connected <span class="number">1365</span>-<span class="number">5460</span></span><br><span class="line">21a288afc7b6addebcd943ca606dd34f6b9c99db <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6398</span>@<span class="number">16398</span> slave 5cf471cf39f0104f69d06c80d0dfdcc8aaa96b7c <span class="number">0</span> <span class="number">1574243295697</span> <span class="number">7</span> connected</span><br><span class="line">63bc9da88066b475bd878a56a11dd18023b211b6 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6394</span>@<span class="number">16394</span> slave 2e0134b0a87a73903d4774b6b37dd43e78e93733 <span class="number">0</span> <span class="number">1574243295000</span> <span class="number">5</span> connected</span><br><span class="line">c3d20b7f2df806ec87f3d45a7e334b5a2d3abe5b <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6395</span>@<span class="number">16395</span> master - <span class="number">0</span> <span class="number">1574243296000</span> <span class="number">3</span> connected <span class="number">12288</span>-<span class="number">16383</span></span><br><span class="line">f6a7c788d9e5d40bc62a3723ba02c25607cc2825 <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6392</span>@<span class="number">16392</span> slave c3d20b7f2df806ec87f3d45a7e33</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
        <div class="reward-container">
  <div>感谢大佬的打赏，我会继续努力哒！</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    Donate
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/vx-pay.jpg" alt="EthanWhite-Chen WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/zfb-pay.jpg" alt="EthanWhite-Chen Alipay">
        <p>Alipay</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/java/" rel="tag"># java</a>
              <a href="/tags/redis%E9%AB%98%E5%8F%AF%E7%94%A8/" rel="tag"># redis高可用</a>
              <a href="/tags/redis%E9%AB%98%E5%B9%B6%E5%8F%91/" rel="tag"># redis高并发</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/05/24/Redis%E6%95%99%E7%A8%8B%EF%BC%9ARedis-%E6%8C%81%E4%B9%85%E5%8C%96/" rel="prev" title="Redis教程：Redis 持久化">
      <i class="fa fa-chevron-left"></i> Redis教程：Redis 持久化
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/05/24/%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C%E7%BC%93%E5%AD%98%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E4%B8%80%E8%87%B4%E6%80%A7%EF%BC%88%E8%B6%85%E8%AF%A6%E7%BB%86%E6%A1%88%E4%BE%8B%EF%BC%89/" rel="next" title="如何保障缓存和数据库的一致性（超详细案例）">
      如何保障缓存和数据库的一致性（超详细案例） <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-replication-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6"><span class="nav-number">1.</span> <span class="nav-text">redis replication 的核心机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="nav-number">2.</span> <span class="nav-text">redis 主从复制的核心原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0"><span class="nav-number">2.1.</span> <span class="nav-text">主从复制的断点续传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A0%E7%A3%81%E7%9B%98%E5%8C%96%E5%A4%8D%E5%88%B6"><span class="nav-number">2.2.</span> <span class="nav-text">无磁盘化复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%9C%9F-key-%E5%A4%84%E7%90%86"><span class="nav-number">2.3.</span> <span class="nav-text">过期 key 处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E7%9A%84%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">复制的完整流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="nav-number">3.1.</span> <span class="nav-text">全量复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="nav-number">3.2.</span> <span class="nav-text">增量复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#heartbeat"><span class="nav-number">3.3.</span> <span class="nav-text">heartbeat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6"><span class="nav-number">3.4.</span> <span class="nav-text">异步复制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-%E5%A6%82%E4%BD%95%E6%89%8D%E8%83%BD%E5%81%9A%E5%88%B0%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">redis 如何才能做到高可用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E5%9F%BA%E4%BA%8E%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">Redis基于哨兵模式实现高可用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-HA-%E5%AE%9E%E8%B7%B5%EF%BC%88Redis-Sentinel%EF%BC%89"><span class="nav-number">6.</span> <span class="nav-text">Redis HA 实践（Redis Sentinel）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Sentinel-%E6%A6%82%E8%BF%B0"><span class="nav-number">6.1.</span> <span class="nav-text">Redis Sentinel 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Sentinel-%E9%87%8D%E7%82%B9%E6%80%BB%E7%BB%93"><span class="nav-number">6.2.</span> <span class="nav-text">Redis Sentinel 重点总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Sentinel-%E6%90%AD%E5%BB%BA"><span class="nav-number">6.3.</span> <span class="nav-text">Redis Sentinel 搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis-Sentinel-%E9%83%A8%E7%BD%B2%E6%8A%80%E5%B7%A7%E5%8F%8A%E5%85%B6%E7%8E%AF%E5%A2%83"><span class="nav-number">6.3.1.</span> <span class="nav-text">Redis Sentinel 部署技巧及其环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis-Sentinel-%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97"><span class="nav-number">6.3.2.</span> <span class="nav-text">Redis Sentinel 安装指南</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Sentinel-%E5%9C%BA%E6%99%AF%E6%B5%8B%E8%AF%95"><span class="nav-number">6.4.</span> <span class="nav-text">Redis Sentinel 场景测试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-HA-%E5%AE%9E%E8%B7%B5%EF%BC%88Redis-Cluster%EF%BC%89"><span class="nav-number">7.</span> <span class="nav-text">Redis HA 实践（Redis Cluster）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Cluster-%E6%A6%82%E8%BF%B0"><span class="nav-number">7.1.</span> <span class="nav-text">Redis Cluster 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Cluster-%E9%87%8D%E7%82%B9%E6%80%BB%E7%BB%93"><span class="nav-number">7.2.</span> <span class="nav-text">Redis Cluster 重点总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Cluster-%E4%B8%8E-Redis-Sentinel-%E5%8C%BA%E5%88%AB"><span class="nav-number">7.3.</span> <span class="nav-text">Redis Cluster 与 Redis Sentinel 区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Cluster-%E6%90%AD%E5%BB%BA"><span class="nav-number">7.4.</span> <span class="nav-text">Redis Cluster 搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis-Cluster-%E9%83%A8%E7%BD%B2%E6%8A%80%E5%B7%A7%E5%8F%8A%E5%85%B6%E7%8E%AF%E5%A2%83"><span class="nav-number">7.4.1.</span> <span class="nav-text">Redis Cluster 部署技巧及其环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Redis-Cluster-%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97"><span class="nav-number">7.4.2.</span> <span class="nav-text">Redis Cluster 安装指南</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">EthanWhite-Chen</p>
  <div class="site-description" itemprop="description">不积跬步无以至千里，不积小流无以成江河。分享点滴成长，就有光明未来！</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ethanwhite-chen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ethanwhite-chen" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/ykchen998@foxmail.com" title="E-Mail → ykchen998@foxmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">EthanWhite-Chen</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">173k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">5:15</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
